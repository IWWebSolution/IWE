<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.8/lottie.min.js"></script>
    <div id="head"></div>
</head>
<body>
    <!-- Header content will be loaded dynamically -->
    <div id="header"></div>

    <!-- Breadcrumb Area -->
    <div class="breadcrumb-area">
        <div class="container">
            <div class="breadcrumb-content">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li class="active">Forgot Password</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Forgot Password Content Area -->
    <div class="page-section mb-60">
        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-md-12 col-xs-12 col-lg-6 mb-30">
                    <!-- Forgot Password Form -->
                    <form id="forgotPasswordForm">
                        <div class="login-form">
                            <h4 class="login-title">Let us help you reset your password!</h4>
                            <div class="row">
                                <!-- Email Input -->
                                <div class="col-md-12 col-12 mb-20">
                                    <label>Enter your registered email address<span class="red">*</span></label>
                                    <input class="mb-0" id="email" name="email" type="email" placeholder="Email Address">
                                    <span class="error" id="emailError"></span>
                                    <span id="emailTick" style="display: none; color: green;">✔</span>
                                </div>

                                <!-- Send OTP Button -->
                                <div class="col-md-12" id="sendOtpSection" style="display: none;">
                                    <button type="button" id="sendOtpButton" class="register-button mt-0">Send OTP / Verification Code</button>
                                    <span id="otpTimer" style="display: none; color: gray;">Resend OTP in <span id="countdown">60</span> seconds</span>
                                </div>

                                <!-- Register Button (Initially Hidden) -->
                                <div class="col-md-12" id="registerButtonSection" style="display: none;">
                                    <button type="button" id="registerButton" class="register-button mt-2">Register</button>
                                </div>

                                <!-- OTP Input -->
                                <div class="col-md-12 col-12 mb-20" id="otpSection" style="display: none;">
                                    <label>Enter verification code<span class="red">*</span></label>
                                    <input class="mb-0" id="otp" name="otp" type="number" placeholder="Enter OTP">
                                    <span class="error" id="otpError"></span>
                                </div>
                                <!-- New Password Input -->
                                <div class="col-md-12 col-12 mb-20" id="newPasswordSection" style="display: none;">
                                    <label>Enter new password<span class="red">*</span></label>
                                    <input class="mb-0" id="newPassword" name="newPassword" type="password" placeholder="New Password">
                                    <span class="error" id="newPasswordError"></span>
                                </div>
                                <!-- Confirm New Password Input -->
                                <div class="col-md-12 col-12 mb-20" id="confirmPasswordSection" style="display: none;">
                                    <label>Confirm new password<span class="red">*</span></label>
                                    <input class="mb-0" id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm New Password">
                                    <span class="error" id="confirmPasswordError"></span>
                                </div>
                                <!-- Save and Login Buttons -->
                                <div class="col-md-12" id="saveSection" style="display: none;">
                                    <button type="button" id="saveButton" class="register-button mt-0">Save New Password</button>
                                    <button type="button" id="loginButton" class="register-button mt-0" onclick="window.location.href='login.html'">Login</button>
                                </div>
                                <!-- Form Response Message -->
                                <div id="formResponse" style="display: none;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- Right Side: Animation -->
                <div class="col-sm-12 col-md-12 col-xs-12 col-lg-6 mb-30">
                    <div id="animationContainer" style="width: 100%; height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer content will be loaded dynamically -->
    <div id="footer"></div>

    <!-- Scripts -->
    <!-- jQuery-V1.12.4 -->
    <script src="js/vendor/jquery-1.12.4.min.js"></script>
    <!-- Popper js -->
    <script src="js/vendor/popper.min.js"></script>
    <!-- Bootstrap V4.1.3 Fremwork js -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Ajax Mail js -->
    <script src="js/ajax-mail.js"></script>
    <!-- Meanmenu js -->
    <script src="js/jquery.meanmenu.min.js"></script>
    <!-- Wow.min js -->
    <script src="js/wow.min.js"></script>
    <!-- Slick Carousel js -->
    <script src="js/slick.min.js"></script>
    <!-- Owl Carousel-2 js -->
    <script src="js/owl.carousel.min.js"></script>
    <!-- Magnific popup js -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Isotope js -->
    <script src="js/isotope.pkgd.min.js"></script>
    <!-- Imagesloaded js -->
    <script src="js/imagesloaded.pkgd.min.js"></script>
    <!-- Mixitup js -->
    <script src="js/jquery.mixitup.min.js"></script>
    <!-- Countdown -->
    <script src="js/jquery.countdown.min.js"></script>
    <!-- Counterup -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Waypoints -->
    <script src="js/waypoints.min.js"></script>
    <!-- Barrating -->
    <script src="js/jquery.barrating.min.js"></script>
    <!-- Jquery-ui -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Venobox -->
    <script src="js/venobox.min.js"></script>
    <!-- Nice Select js -->
    <script src="js/jquery.nice-select.min.js"></script>
    <!-- ScrollUp js -->
    <script src="js/scrollUp.min.js"></script>
    <!-- Main/Activator js -->
    <script src="js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.8/lottie.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const emailInput = document.getElementById("email");
            const emailError = document.getElementById("emailError");
            const emailTick = document.getElementById("emailTick");
            const sendOtpButton = document.getElementById("sendOtpButton");
            const sendOtpSection = document.getElementById("sendOtpSection");
            const registerButton = document.getElementById("registerButton");
            const registerButtonSection = document.getElementById("registerButtonSection");
            const otpSection = document.getElementById("otpSection");
            const otpInput = document.getElementById("otp");
            const otpError = document.getElementById("otpError");
            const newPasswordSection = document.getElementById("newPasswordSection");
            const confirmPasswordSection = document.getElementById("confirmPasswordSection");
            const saveSection = document.getElementById("saveSection");
            const saveButton = document.getElementById("saveButton");
            const formResponse = document.getElementById("formResponse");

            // ✅ 1. Send OTP
            emailInput.addEventListener("blur", function () {
                const email = emailInput.value.trim();
                if (email === "") {
                    emailError.textContent = "Email is required!";
                    return;
                }
                
                // Send email to backend to check if it exists
                fetch("/send-otp/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        emailError.textContent = "";
                        emailTick.style.display = "inline";  // Show ✔ tick
                        sendOtpSection.style.display = "block";  // Show "Send OTP" button
                        registerButtonSection.style.display = "none";  // Hide Register button
                    } else {
                        emailError.textContent = data.error;
                        emailTick.style.display = "none";
                        sendOtpSection.style.display = "none";  // Hide OTP button
                        registerButtonSection.style.display = "block";  // Show Register button
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ 2. Click Send OTP Button
            sendOtpButton.addEventListener("click", function () {
                const email = emailInput.value.trim();
                fetch("/send-otp/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        sendOtpButton.disabled = true;
                        startOtpTimer(); // Start OTP countdown
                        otpSection.style.display = "block";  // Show OTP input field
                    } else {
                        formResponse.textContent = data.error;
                        formResponse.style.display = "block";
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ 3. Verify OTP
            otpInput.addEventListener("blur", function () {
                const email = emailInput.value.trim();
                const otp = otpInput.value.trim();

                if (otp === "") {
                    otpError.textContent = "OTP is required!";
                    return;
                }

                fetch("/verify-otp/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email, otp: otp }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        otpError.textContent = "";
                        newPasswordSection.style.display = "block";
                        confirmPasswordSection.style.display = "block";
                        saveSection.style.display = "block";
                    } else {
                        otpError.textContent = "Invalid OTP!";
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ 4. Reset Password
            saveButton.addEventListener("click", function () {
                const email = emailInput.value.trim();
                const newPassword = document.getElementById("newPassword").value.trim();
                const confirmPassword = document.getElementById("confirmPassword").value.trim();

                if (newPassword === "" || confirmPassword === "") {
                    formResponse.textContent = "Both password fields are required!";
                    formResponse.style.display = "block";
                    return;
                }
                if (newPassword !== confirmPassword) {
                    formResponse.textContent = "Passwords do not match!";
                    formResponse.style.display = "block";
                    return;
                }

                fetch("/reset-password/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email, new_password: newPassword, confirm_password: confirmPassword }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        formResponse.textContent = "Password reset successful! Redirecting to login...";
                        formResponse.style.color = "green";
                        setTimeout(() => window.location.href = "login.html", 3000);
                    } else {
                        formResponse.textContent = data.error;
                        formResponse.style.color = "red";
                    }
                    formResponse.style.display = "block";
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ OTP Timer Countdown (60 sec)
            function startOtpTimer() {
                let countdown = 60;
                const otpTimer = document.getElementById("otpTimer");
                const countdownSpan = document.getElementById("countdown");

                otpTimer.style.display = "inline";
                const timerInterval = setInterval(() => {
                    countdown -= 1;
                    countdownSpan.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timerInterval);
                        sendOtpButton.disabled = false;
                        otpTimer.style.display = "none";
                    }
                }, 1000);
            }
        });

    </script>
</body>
</html>